# Tom Build Kit — Consolidation Issues

Tracked issues from the tool consolidation (5 standalone tools → tom_build_kit).

## Status Legend

- [ ] Open
- [x] Done

---

## Cross-Cutting Issues (All Tools)

### 1. Missing --version flag
- [x] All 5 tool binaries and buildkit itself must support `--version`, `-version`, and `version` as first argument
- [x] All tools share a single `TomVersionInfo` from `version.versioner.dart` since they are in the same package
- Files: `tool_base.dart`, all `bin/*.dart`

### 2. Glob-based exclusion broken in ToolBase
- [x] `ToolBase._filterProjects()` uses `path.contains(pattern)` (substring match) instead of proper `Glob.matches()`
- [x] Original tools used `Glob` for `--exclude` pattern matching
- File: `lib/src/commands/tool_base.dart`

### 3. Uniform --project / --scan / --recursive
- [x] All tools parse these via `ToolBase.createParser()` — already uniform
- [x] `--dry-run` added to VersionerTool and DependenciesTool via ToolBase base parser
- [x] `--show` now functional in DependenciesTool
- [x] `validatePathContainment()` called in DependenciesTool
- Files: `versioner_tool.dart`, `dependencies_tool.dart`

### 4. Remove backward-compatible key detection
- [x] CleanupTool `loadFromBuildYaml()` — removed fallback to `tom_cleanup_builder:cleanup_builder`
- [x] CleanupTool `_hasBuildYamlCleanupConfig()` — removed check for `tom_cleanup_builder:cleanup_builder`
- [x] VersionerTool `loadFromBuildYaml()` — removed fallback to `tom_version_builder:version_builder`
- [x] VersionerTool `_hasBuildYamlVersionConfig()` — removed check for `tom_version_builder:version_builder`
- [x] CompilerTool `loadFromBuildYaml()` — removed fallback to `tom_compiler_builder:compiler_builder`
- [x] CompilerTool `isToolProject()` — removed check for `tom_compiler_builder:compiler_builder`
- [x] RunnerTool `BuilderFilterConfig.loadFromBuildYaml()` — changed from `tom_build_runner` to `tom_build_kit`
- [x] buildkit.dart — removed backward compatibility comment
- Files: `cleanup_tool.dart`, `versioner_tool.dart`, `compiler_tool.dart`, `runner_tool.dart`, `buildkit.dart`

### 5. Per-project config loading gaps
- [x] CompilerTool `processProject()` — now loads per-project `buildkit.yaml` before `build.yaml`
- [x] RunnerTool `processProject()` — now loads per-project `BuildRunnerConfig` from `buildkit.yaml`; uses `projectConfig` throughout
- [x] DependenciesTool — loads no config (CLI-only); acceptable since it reads `pubspec.yaml` directly
- Files: `compiler_tool.dart`, `runner_tool.dart`

---

## Per-Tool Issues

### 6. Versioner — generated file format differs from original
- [x] `versionShort` is now `get` returning `'$version+$buildNumber'`
- [x] `versionMedium` is now `get` returning `'$version+$buildNumber.$gitCommit ($buildTime)'`
- [x] `versionLong` is now `get` returning `'$version+$buildNumber.$gitCommit ($buildTime) [Dart $dartSdkVersion]'`
- [x] Removed `packageName` field (not in original format)
- [x] Header comment: uses `Generated by versioner at $buildTime`
- [x] Both `versioner_tool.dart` and `version_builder.dart` templates are synchronized
- Files: `versioner_tool.dart`, `builders/version_builder.dart`

### 7. Compiler — env var regex and placeholder resolution
- [x] `_replaceEnvVars()` regex: changed to `\$(\w+)` to match original
- [x] `_replaceEnvVars()`: bracket format `[VAR]` uses `\[(\w+)\]`
- [x] `_runCommandSection()`: `${current-platform}` now resolves to `PlatformUtils.vsCodeToDartTarget(currentPlatform)` (Dart target format)
- Files: `compiler_tool.dart`

### 8. Runner — buildkit.yaml key and builder filtering
- [x] `BuildRunnerConfig.loadFromYaml()` reads `build_runner:` key (was `runner:`)
- [x] `BuilderFilterConfig.loadFromBuildYaml()` reads `tom_build_kit` top-level key (was `tom_build_runner`)
- [x] Builder filtering uses fuzzy substring matching (`b.contains(include) || include.contains(b)`)
- [x] Added `BuilderFilterConfig.toString()` override for verbose logging
- Files: `runner_tool.dart`

### 9. Cleanup — builder behavior and YAML parsing
- [x] `CleanupBuilder.build()` stays validation-only — actual cleanup is done by CLI tool (CleanupTool). This is correct since build_runner builders should not delete files outside build cache.
- [x] `CleanupConfig.loadFromYaml()` now handles both `YamlMap` (nested `cleanup:` key) and direct `YamlList` format
- [x] Global `excludes:` parsing from `buildkit.yaml` already implemented in map format
- Files: `cleanup_tool.dart`, `builders/cleanup_builder.dart`

### 10. Dependencies — path resolution
- [x] `_resolveDependencyPath()` now resolves relative paths against the project directory; supports `--deep` mode with path dependencies
- Files: `dependencies_tool.dart`

---

## Documentation

### 11. Create tools_user_guide.md
- [x] Common configuration section (shared CLI options, buildkit.yaml structure, build.yaml structure)
- [x] Per-tool sections: cleanup, compiler, dependencies, runner, versioner
- [x] BuildKit orchestrator section with pipelines, direct commands, per-tool override
- [x] Table of contents with links
- File: `doc/tools_user_guide.md`

---

## Fixed Issues (Bugs #12–#19)

### 12. Versioner config merge-order bug
- [x] Reversed `merge()` so caller (`this`) takes precedence over `other`
- [x] Implemented 3-way merge in `generateVersionFile()`: `cliConfig.merge(yamlConfig.merge(wsConfig))` → CLI > project > workspace
- [x] `--no-git` and `--variable-prefix` now correctly override project config
- Files: `lib/src/commands/versioner_tool.dart`

### 13. VersionBump `-v` abbreviation conflict
- [x] Removed `abbr: 'v'` from `--versioner` flag definition
- [x] No longer conflicts with `--verbose` (`-v`) from ToolBase
- Files: `lib/src/commands/versionbump_tool.dart`

### 14. BuiltinCommands dry-run inconsistency
- [x] All `_run*()` methods now set `tool.dryRun = dryRun` before calling `tool.run(args)`
- [x] Removed early bail-out that skipped tool execution during dry-run
- Files: `lib/src/pipeline/builtin_commands.dart`

### 15. BuildKit global flags after pipeline/command name are silently ignored
- [x] Added `_warnOnMisplacedFlags()` that detects known global flags in `results.rest` and prints a warning
- [x] Preserves `allowTrailingOptions: false` parsing behavior (by design — changing it would break step arg forwarding)
- [x] Users see a clear warning when flags are placed after the pipeline name
- Files: `bin/buildkit.dart`

### 16. Dependencies `--deep` fails to resolve relative path dependencies
- [x] `_resolveDependencyPath()` now accepts `String projectPath` parameter and resolves relative paths against it
- [x] Path resolution threaded through `_printDependencyTree()` to the resolution call site
- [x] `--deep` now correctly follows transitive path dependencies
- Files: `lib/src/commands/dependencies_tool.dart`

### 17. Cleanup `protected-folders` silently ignores multi-segment paths
- [x] Rewrote `_isInProtectedFolder()` with dual strategy: single-segment entries use fast `parts.contains()` lookup; multi-segment entries use `Glob('**/$folder/**')` matching
- [x] `protected-folders: ['lib/src']` now correctly protects only the `lib/src/` subtree
- Files: `lib/src/commands/cleanup_tool.dart`

### 18. BuildKit pipeline steps don't forward `--project` to built-in tool commands
- [x] `BuiltinCommands.execute()` now injects `['--project', projectPath, ...args]` when `--project` is not already in args
- [x] Built-in tool commands automatically receive the pipeline's `--project` path
- Files: `lib/src/pipeline/builtin_commands.dart`

### 19. All tools accept non-existent `--project` path without error
- [x] Added `findProjectsError` flag and path validation in `ToolBase.findProjects()` for non-glob `--project` values
- [x] All 6 tool `run()` methods now check `if (findProjectsError) return false;` after `findProjects()`
- [x] Non-existent `--project` paths now produce clear error message and non-zero exit code
- Files: `lib/src/commands/tool_base.dart`, all `*_tool.dart` files
