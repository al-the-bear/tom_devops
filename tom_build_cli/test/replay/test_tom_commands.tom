# Tom CLI Command Tests - Tests for Tom-specific CLI functionality
# Run with: tom -run-replay test_tom_commands.tom -test
# Tests Tom internal commands and CLI features

import 'dart:io';
import 'dart:convert';

# =============================================================================
# Test: Version Command
# =============================================================================

# Test that :version works (we can capture output from command execution)
# Note: :version returns a CommandResult, not REPL output, so we verify via API

var versionInfo = '1.0.0+3';
verifyContains(versionInfo, '1.0.0', 'Version string should contain version number');

# =============================================================================
# Test: Help Command Verification
# =============================================================================

# Verify help text content by checking known command names
var helpKeywords = ['analyze', 'version-bump', 'generate-bridges', 'help', 'version'];
verifyEquals(helpKeywords.length, 5, 'Should have 5 help keywords');
verify(helpKeywords.contains('analyze'), 'Help should include analyze command');

# =============================================================================
# Test: Internal Command Registry
# =============================================================================

# Test that internal command names are correct format
var commands = ['analyze', 'version-bump', 'generate-bridges', 'prepper'];
var sum = commands.fold<int>(0, (acc, cmd) => acc + cmd.length);
verify(sum > 25, 'Total command name length should be > 25');

# Verify command prefixes
var prefixes = {'analyze': 'wa', 'generate-bridges': 'gb', 'version-bump': 'vb'};
verifyEquals(prefixes['analyze'], 'wa', 'Analyze prefix should be wa');

# =============================================================================
# Test: Tom Bridges (TomCliApiBridges)
# =============================================================================

# Test TomLog functionality (bridged from tom_cli_api)
# We can test that basic types work through the bridge layer
var logMessage = 'Test log message for Tom CLI';
verifyEquals(logMessage.length, 28, 'Log message should have correct length');

# =============================================================================
# Test: String Processing for Commands
# =============================================================================

# Test command line parsing logic
var cmdLine = ':analyze -verbose -dry-run';
var parts = cmdLine.split(' ');
verifyEquals(parts.length, 3, 'Command should split into 3 parts');
verifyEquals(parts[0], ':analyze', 'First part should be command');
verifyEquals(parts[1], '-verbose', 'Second part should be option');

# Test quoted string parsing
var quotedCmd = 'file="path with spaces.txt"';
var eqIndex = quotedCmd.indexOf('=');
var key = quotedCmd.substring(0, eqIndex);
var value = quotedCmd.substring(eqIndex + 1);
verifyEquals(key, 'file', 'Key should be extracted');
verifyEquals(value, '"path with spaces.txt"', 'Value should include quotes');

# =============================================================================
# Test: Path Operations
# =============================================================================

var testPath = '/Users/test/projects/tom/lib/src/file.dart';
var parts2 = testPath.split('/');
verifyEquals(parts2.last, 'file.dart', 'Last path segment should be filename');
verify(parts2.length > 5, 'Path should have multiple segments');

# Test path joining simulation
var joinedPath = ['lib', 'src', 'tom_d4rt'].join('/');
verifyEquals(joinedPath, 'lib/src/tom_d4rt', 'Path segments should join with /');

# =============================================================================
# Test: JSON Configuration Parsing
# =============================================================================

# Simulate parsing a build.yaml style config using JSON
var configJson = '{"targets": {"lib": {"output": "lib/src/version.versioner.dart"}}}';
var config = jsonDecode(configJson);
var targets = config['targets'] as Map;
verifyNotNull(targets, 'Targets should exist');
var libTarget = targets['lib'] as Map;
verifyNotNull(libTarget, 'lib target should exist');
verifyEquals(libTarget['output'], 'lib/src/version.versioner.dart', 'Output path should match');

# =============================================================================
# Test: Tom Workspace YAML Structure
# =============================================================================

# Simulate workspace config structure using JSON
var wsJson = '{"version": "1.0.0", "mode": "development", "projects": ["tom_cli_api", "tom_build", "tom_build_cli"], "verbose": true}';
var workspaceConfig = jsonDecode(wsJson);

verifyEquals(workspaceConfig['version'], '1.0.0', 'Workspace version should match');
verifyEquals(workspaceConfig['mode'], 'development', 'Mode should be development');

var projects = workspaceConfig['projects'] as List;
verifyEquals(projects.length, 3, 'Should have 3 projects');
verify(projects.contains('tom_build'), 'Projects should include tom_build');

verifyEquals(workspaceConfig['verbose'], true, 'Verbose should be true');

# =============================================================================
# Test: Define Tom-specific Function
# =============================================================================

.start-define
String formatCommandResult(bool success, String message, int duration) {
  final status = success ? 'SUCCESS' : 'FAILED';
  return '[$status] $message (${duration}ms)';
}
.end

var result = formatCommandResult(true, 'Build completed', 1500);
verifyContains(result, 'SUCCESS', 'Result should contain SUCCESS');
verifyContains(result, 'Build completed', 'Result should contain message');
verifyContains(result, '1500ms', 'Result should contain duration');

# =============================================================================
# Test: Define Class for Command Handling
# =============================================================================

.start-define
class SimpleCommand {
  final String name;
  final String description;
  final bool requiresWorkspace;
  
  SimpleCommand(this.name, this.description, {this.requiresWorkspace = false});
  
  bool matches(String input) => input == ':$name' || input.startsWith(':$name ');
  
  @override
  String toString() => ':$name - $description';
}
.end

var analyzeCmd = SimpleCommand('analyze', 'Run workspace analyzer', requiresWorkspace: true);
verifyEquals(analyzeCmd.name, 'analyze', 'Command name should match');
verify(analyzeCmd.requiresWorkspace, 'Analyze should require workspace');
verify(analyzeCmd.matches(':analyze'), 'Should match exact command');
verify(analyzeCmd.matches(':analyze -verbose'), 'Should match command with options');
verify(!analyzeCmd.matches(':help'), 'Should not match different command');

# =============================================================================
# Summary
# =============================================================================

testSummary();
